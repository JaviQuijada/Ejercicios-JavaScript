<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ejercicios con Clases en Javascript Ejercicio 11</title>
    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <a href="../clases.html" class="btn-volver">‚Üê Volver al √≠ndice</a>

        <h1>Ejercicio 11 Twitter con Tweets y Usuarios</h1>
        <p>
          Crear las siguientes clases con sus respectivos m√©todos y propiedades.
          Usar propiedades privadas. Cuando se devuelvan valores, si son objetos
          y arrays de las propiedades, devolver copias de los mismo, para evitar
          que puedan ser modificados.
        </p>
        <p style="color: var(--secondary-color); margin-top: 0.5rem">
          ### Usuario <br />
          - **Propiedades** <br />
          - handle (string) <br />
          - siguiendo (array de `Usuario`), inicializa vac√≠o <br />
          - **Constructor** <br />
          - pide `handle` como argumento y lo agrega a su respectiva <br />
          propiedad <br />
          - **M√©todos** <br />
          - **`seguir(usuario)`** agrega `usuario` a `siguiendo`, *s <br />i no
          se encuentra <br />
          ya en dicho array* y *si <br />
          no es el propio u <br />suario* (no se puede seguir a s√≠ mismo) <br />
          - getters para obtener los valores de todas las propiedade <br />s
          <br />
          <br />
          ### Tweet <br />
          - **Propiedades** <br />
          - id (string) <br />
          - handle (`string`) <br />
          - texto (string) <br />
          - likes (array de `Usuario`), inicializa en 0 <br />
          - retweets (array de `Usuario), inicializa en 0 <br />
          - **Constructor** <br />
          - genera un `id` autom√°tico y lo asigna a su propiedad <br />
          - pide `handle` y `texto` como argumentos y los agrega a s <br />us
          respectivas pr <br />opiedades <br />
          - **M√©todos** <br />
          - getters para obtener los valores de todas las propiedade <br />s
          <br />
          - **`darLike(usuario)`** agrega `usuario` a `likes`, *si y <br />a se
          encuentra en <br />
          dicho array, debe remove <br />rlo de mismo* <br />
          - **`retweetear(usuario)`** agrega `usuario` a `retweets`, <br />
          *si ya se encuen <br />tra en dicho array, debe <br />removerlo de
          mismo* <br />
          <br />
          ### Twitter <br />
          - **Propiedades** <br />
          - tweets (array de `Tweet`), inicializa vac√≠o <br />
          - **M√©todos** <br />
          - **`twittear(tweet)`** agrega `tweet` a `tweets`, *si dic <br />ho
          `tweet` no se <br />encuentra actualmente en <br />el array* <br />
          - **`obtenerTimeline(usuario)`** devuelve un array de twee <br />ts
          del `usuario`. <br />
          Este array se compone de <br />
          - todos los tweets publicados por los usuarios que sigue <br />
          - todos los tweets likeados por los usuarios que sigue <br />
          - todos los tweets retweeteados por los usuarios que sigue <br />
          - no debe haber tweets repetidos <br />
          - deben estar ordenados de m√°s nuevos a m√°s viejos <br />
          - **Observaciones** <br />
          - Es recomendable crear m√©todos privados para simplificar
          `obtenerTimeline` <br />
        </p>
      </header>

      <main>
        <button type="button" class="btn-refresh" onclick="location.reload()">
          <span class="icon">‚Üª</span> Actualizar P√°gina
        </button>
      </main>
    </div>
    <script src="./js/script.js"></script>
    <script>
      class Usuario {
        #handle;
        #siguiendo = [];

        constructor(handle) {
          this.#handle = handle.startsWith("@") ? handle : `@${handle}`;
        }

        get handle() {
          return this.#handle;
        }
        get siguiendo() {
          return this.#siguiendo.map((u) => u.handle);
        }
        get instanciasSeguidas() {
          return this.#siguiendo;
        }

        seguir(usuario) {
          if (!(usuario instanceof Usuario))
            throw new Error("Debe ser un Usuario.");
          if (usuario.handle === this.#handle)
            throw new Error("No puedes seguirte a ti mismo.");
          const yaSigue = this.#siguiendo.some(
            (u) => u.handle === usuario.handle
          );
          if (!yaSigue) this.#siguiendo.push(usuario);
        }
      }

      class Tweet {
        #id;
        #handle;
        #texto;
        #likes = [];
        #retweets = [];
        #fecha;

        constructor(handle, texto) {
          // Generamos un ID corto de 4 caracteres para que sea f√°cil de escribir
          this.#id = Math.random().toString(36).substring(2, 6).toUpperCase();
          this.#handle = handle;
          this.#texto = texto;
          this.#fecha = new Date();
        }

        get id() {
          return this.#id;
        }
        get handle() {
          return this.#handle;
        }
        get texto() {
          return this.#texto;
        }
        get fecha() {
          return this.#fecha;
        }
        get likes() {
          return [...this.#likes];
        }
        get retweets() {
          return [...this.#retweets];
        }

        #toggle(array, usuario) {
          const index = array.findIndex((u) => u.handle === usuario.handle);
          if (index === -1) array.push(usuario);
          else array.splice(index, 1);
        }

        darLike(usuario) {
          this.#toggle(this.#likes, usuario);
        }
        retweetear(usuario) {
          this.#toggle(this.#retweets, usuario);
        }

        toObject() {
          return {
            id: this.#id,
            handle: this.#handle,
            texto: this.#texto,
            likesCount: this.#likes.length,
            rtCount: this.#retweets.length,
            fecha: this.#fecha,
          };
        }
      }

      class Twitter {
        #tweets = [];

        twittear(tweet) {
          this.#tweets.push(tweet);
        }

        buscarTweet(id) {
          return this.#tweets.find((t) => t.id === id.toUpperCase());
        }

        obtenerTimeline(usuario) {
          const seguidos = usuario.instanciasSeguidas;
          // El timeline incluye: tweets de seguidos, o cosas que seguidos likearon/RT
          const timeline = this.#tweets.filter((t) => {
            const esDeSeguido = seguidos.some((s) => s.handle === t.handle);
            const likeDeSeguido = seguidos.some((s) =>
              t.likes.some((u) => u.handle === s.handle)
            );
            const rtDeSeguido = seguidos.some((s) =>
              t.retweets.some((u) => u.handle === s.handle)
            );
            return esDeSeguido || likeDeSeguido || rtDeSeguido;
          });

          return timeline
            .sort((a, b) => b.fecha - a.fecha)
            .map((t) => t.toObject());
        }
      }

      // --- INTERFAZ ---
      const miApp = new Twitter();
      const usersDB = [
        new Usuario("@JS_Master"),
        new Usuario("@WebDev"),
        new Usuario("@OpenAI"),
      ];

      // Tweets iniciales
      miApp.twittear(
        new Tweet("@JS_Master", "Las clases privadas son geniales.")
      );
      miApp.twittear(
        new Tweet("@WebDev", "Usa .map() para transformar arrays.")
      );

      const miUser = new Usuario(prompt("Tu nombre de usuario:") || "@anonimo");

      let loop = true;
      while (loop) {
        const menu =
          `üê¶ TWITTER (${miUser.handle})\n` +
          `------------------------\n` +
          `1. Twittear algo\n` +
          `2. VER TIMELINE (Aqu√≠ ver√°s los IDs)\n` +
          `3. Seguir usuarios\n` +
          `4. Dar Like / RT (necesitas el ID)\n` +
          `5. Salir`;

        const op = prompt(menu);

        switch (op) {
          case "1":
            const txt = prompt("¬øQu√© piensas?");
            if (txt) miApp.twittear(new Tweet(miUser.handle, txt));
            break;

          case "2":
            const tl = miApp.obtenerTimeline(miUser);
            if (tl.length === 0) {
              alert(
                "Tu timeline est√° vac√≠o. Sigue a alguien primero (Opci√≥n 3)."
              );
            } else {
              const str = tl
                .map(
                  (t) =>
                    `üÜî ID: ${t.id}\nüë§ ${t.handle}: "${t.texto}"\n‚ù§Ô∏è ${t.likesCount} | üîÅ ${t.rtCount}\n`
                )
                .join("----------\n");
              alert("üè† TU INICIO:\n\n" + str);
            }
            break;

          case "3":
            const lista = usersDB.map((u, i) => `${i}. ${u.handle}`).join("\n");
            const idx = prompt("Elige a qui√©n seguir:\n" + lista);
            if (usersDB[idx]) {
              miUser.seguir(usersDB[idx]);
              alert("Ahora sigues a " + usersDB[idx].handle);
            }
            break;

          case "4":
            const idBusca = prompt("Escribe el ID del tweet (ej: A1B2):");
            const tw = miApp.buscarTweet(idBusca);
            if (tw) {
              const accion = prompt("¬øQu√© quieres hacer?\n1. Like\n2. Retweet");
              if (accion === "1") tw.darLike(miUser);
              if (accion === "2") tw.retweetear(miUser);
              alert("¬°Hecho!");
            } else {
              alert("Ese ID no existe.");
            }
            break;

          case "5":
            loop = false;
            break;
        }
      }
    </script>
  </body>
</html>
