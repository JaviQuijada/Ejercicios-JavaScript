<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ejercicios con Clases en Javascript Ejercicio 7</title>
    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <a href="../clases.html" class="btn-volver">‚Üê Volver al √≠ndice</a>

        <h1>Ejercicio 7 Carrito con Producto</h1>
        <p>
          Crear las siguientes clases con sus respectivos m√©todos y propiedades.
          Usar propiedades privadas. Cuando se devuelvan valores, si son objetos
          y arrays de las propiedades, devolver copias de los mismo, para evitar
          que puedan ser modificados.
        </p>
        <p style="color: var(--secondary-color); margin-top: 0.5rem">
          ### Producto <br />
          - **Propiedades** <br />
          - id (string) <br />
          - nombre (string) <br />
          - precio (n√∫mero) <br />
          - cantidad (n√∫mero) <br />
          - tieneImpuesto (booleano) <br />
          - **Constructor** <br />
          - toma como argumentos `nombre`, `precio`, `cantidad` y
          `tieneImpuesto` y los asigna a sus respectivas propiedades <br />
          - genera un `id` autom√°tico y lo asigna a su propiedad <br />
          - **M√©todos** <br />
          - getters para obteners los valores de todas las propiedades <br />
          - setter para modificar el valor de `cantidad` <br />
          - **Observaciones** <br />
          - la cantidad nunca puede ser 0 <br />
          - el precio no puede ser menor a 0 <br />
          <br />
          ### Carrito <br />
          - **Propiedades** <br />
          - productos (array de `Producto`), inicializa vac√≠o <br />
          - **M√©todos** <br />
          - **`agregarProducto(producto)`** agrega `producto` a `productos
          <br />
          - **`actualizarCantidadProducto(id, cantidad)`** actualiza la
          `cantidad` del producto en `productos` con `id` <br />
          - **`eliminarProducto(id)`** elimina de `productos` el producto con
          `id` <br />
          - **`calcularTotal()`** devuelve el total del carrito (con impuestos
          incluidos) <br />
          - **`calcularImpuestoTotal()`** devuelve el total de la suma de los
          impuestos de cada producto que `tieneImpuesto` <br />
          - **`obtenerCantidadTotal()`** devuelve la cantidad total de √≠tems en
          el producto <br />
          - **`toString()`** devuelve un string con <br />
          - la lista de productos, detallando nombre, precio por unidad y
          cantidad <br />
          - subtotal de todos los productos sin sumar impuesto <br />
          - subtotal de todos los impuestos sumados <br />
          - total final (suma de los subtotales) <br />
          - **Observaciones** - el impuesto es del 10% sobre el precio del
          producto
        </p>
      </header>

      <main>
        <button type="button" class="btn-refresh" onclick="location.reload()">
          <span class="icon">‚Üª</span> Actualizar P√°gina
        </button>
      </main>
    </div>
    <script src="./js/script.js"></script>
    <script>
      class Producto {
        // Propiedades privadas
        #id;
        #nombre;
        #precio;
        #cantidad;
        #tieneImpuesto;

        constructor(nombre, precio, cantidad, tieneImpuesto) {
          if (precio < 0) throw new Error("El precio no puede ser menor a 0");
          if (cantidad <= 0) throw new Error("La cantidad debe ser mayor a 0");

          this.#id = crypto.randomUUID().slice(0, 8); // Genera ID autom√°tico corto
          this.#nombre = nombre;
          this.#precio = precio;
          this.#cantidad = cantidad;
          this.#tieneImpuesto = tieneImpuesto;
        }

        // Getters
        get id() {
          return this.#id;
        }
        get nombre() {
          return this.#nombre;
        }
        get precio() {
          return this.#precio;
        }
        get cantidad() {
          return this.#cantidad;
        }
        get tieneImpuesto() {
          return this.#tieneImpuesto;
        }

        // Setter para cantidad
        set cantidad(nuevaCantidad) {
          if (nuevaCantidad <= 0)
            throw new Error("La cantidad debe ser mayor a 0");
          this.#cantidad = nuevaCantidad;
        }

        // M√©todo para obtener una copia del objeto de datos del producto
        obtenerDatos() {
          return {
            id: this.#id,
            nombre: this.#nombre,
            precio: this.#precio,
            cantidad: this.#cantidad,
            tieneImpuesto: this.#tieneImpuesto,
          };
        }
      }

      class Carrito {
        #productos = [];
        #IVA = 0.1; // 10% de impuesto

        agregarProducto(producto) {
          if (!(producto instanceof Producto)) {
            throw new Error(
              "Solo se pueden agregar instancias de la clase Producto"
            );
          }
          this.#productos.push(producto);
        }

        actualizarCantidadProducto(id, cantidad) {
          const producto = this.#productos.find((p) => p.id === id);
          if (!producto) throw new Error("Producto no encontrado");
          producto.cantidad = cantidad; // Usa el setter de la clase Producto
        }

        eliminarProducto(id) {
          const indice = this.#productos.findIndex((p) => p.id === id);
          if (indice === -1) throw new Error("ID no encontrado en el carrito");
          this.#productos.splice(indice, 1);
        }

        calcularImpuestoTotal() {
          return this.#productos.reduce((total, p) => {
            if (p.tieneImpuesto) {
              return total + p.precio * this.#IVA * p.cantidad;
            }
            return total;
          }, 0);
        }

        calcularTotal() {
          const subtotal = this.#productos.reduce(
            (total, p) => total + p.precio * p.cantidad,
            0
          );
          return subtotal + this.calcularImpuestoTotal();
        }

        obtenerCantidadTotal() {
          return this.#productos.reduce((total, p) => total + p.cantidad, 0);
        }

        toString() {
          if (this.#productos.length === 0) return "El carrito est√° vac√≠o.";

          let lista = "üõí DETALLE DEL CARRITO:\n----------------------\n";
          let subtotalSinImpuesto = 0;

          this.#productos.forEach((p) => {
            const sub = p.precio * p.cantidad;
            subtotalSinImpuesto += sub;
            lista += `- ${p.nombre} (ID: ${p.id}): $${p.precio} x ${p.cantidad} = $${sub}\n`;
          });

          const impuestoTotal = this.calcularImpuestoTotal();

          lista += `----------------------\n`;
          lista += `Subtotal sin impuestos: $${subtotalSinImpuesto.toFixed(
            2
          )}\n`;
          lista += `Total Impuestos (10%): $${impuestoTotal.toFixed(2)}\n`;
          lista += `TOTAL FINAL: $${(
            subtotalSinImpuesto + impuestoTotal
          ).toFixed(2)}`;

          return lista;
        }
      }

      // --- Interacci√≥n con el usuario ---

      const miCarrito = new Carrito();

      function ejecutarTienda() {
        let ejecutando = true;
        while (ejecutando) {
          const menu =
            `üõçÔ∏è MI TIENDA\n\n` +
            `1. Agregar Producto\n` +
            `2. Ver Carrito\n` +
            `3. Actualizar Cantidad\n` +
            `4. Eliminar Producto\n` +
            `5. Salir`;

          const opcion = prompt(menu);

          try {
            switch (opcion) {
              case "1":
                const nom = prompt("Nombre del producto:");
                const pre = parseFloat(prompt("Precio:"));
                const can = parseInt(prompt("Cantidad:"));
                const imp = confirm("¬øLleva impuesto del 10%?");

                const nuevoProd = new Producto(nom, pre, can, imp);
                miCarrito.agregarProducto(nuevoProd);
                alert("‚úÖ Producto a√±adido.");
                break;

              case "2":
                alert(miCarrito.toString());
                console.log(miCarrito.toString());
                break;

              case "3":
                const idAct = prompt("Introduce el ID del producto:");
                const nuevaCan = parseInt(prompt("Nueva cantidad:"));
                miCarrito.actualizarCantidadProducto(idAct, nuevaCan);
                alert("üîÑ Cantidad actualizada.");
                break;

              case "4":
                const idElim = prompt("Introduce el ID a eliminar:");
                miCarrito.eliminarProducto(idElim);
                alert("üóëÔ∏è Producto eliminado.");
                break;

              case "5":
              case null:
                ejecutando = false;
                break;
            }
          } catch (e) {
            alert("‚ö†Ô∏è " + e.message);
          }
        }
      }

      ejecutarTienda();
    </script>
  </body>
</html>
