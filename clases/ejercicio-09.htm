<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ejercicios con Clases en Javascript Ejercicio 9</title>
    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <a href="../clases.html" class="btn-volver">‚Üê Volver al √≠ndice</a>

        <h1>Ejercicio 9 Librer√≠a con Libros con Autor</h1>
        <p>
          Crear las siguientes clases con sus respectivos m√©todos y propiedades.
          Usar propiedades privadas. Cuando se devuelvan valores, si son objetos
          y arrays de las propiedades, devolver copias de los mismo, para evitar
          que puedan ser modificados.
        </p>
        <p style="color: var(--secondary-color); margin-top: 0.5rem">
          ### Autor <br />
          - **Propiedades** <br />
          - nombre (string) <br />
          - nacionalidad (string) <br />
          - **Constructor** <br />
          - pide como argumentos `nombre` y `nacionalidad` y los asigna a sus
          respectivas propiedades <br />
          - **M√©todos** <br />
          - getters para obtener los valores de todas las propiedades <br />
          <br />
          ### Libro <br />
          - **Propiedades** <br />
          - id (string) <br />
          - titulo (string) <br />
          - autor (`Autor`) <br />
          - precio (n√∫mero) <br />
          - genero (string) <br />
          - stock (n√∫mero) <br />
          - **Constructor** <br />
          - genera un `id` autom√°tico y lo asigna a su propiedad <br />
          - el resto de propiedades las pide como argumentos y las asigna seg√∫n
          corresponda <br />
          - **M√©todos** <br />
          - **`tieneStock()`** devuelve `true` si `stock` es mayor a 0, `false`
          sino <br />
          - getters para obtener los valores de todas las propiedades, menos
          `stock` <br />
          - setter para modificar los valores de `precio` y `stock` <br />
          - **Observaciones** <br />
          - `stock` y `precio` tienen como valor m√≠nimo 0 <br />
          <br />
          ### Libreria <br />
          - **Propiedades** <br />
          - libros (array de `Libro), inicializa vac√≠o <br />
          - ganancias (n√∫mero), inicializa en 0 <br />
          - **M√©todos** <br />
          - **`agregar(libro)`** agrega `libro` a `libros` <br />
          - **`eliminar(id)`** elimina de `libros` el libro con `id` <br />
          - **`buscarPorId(id)`** devuelve la informaci√≥n de un libro con `id`
          <br />
          - **`buscarPorTitulo(titulo)`** devuelve la informaci√≥n de un libro
          con `titulo` <br />
          - **`filtrarPorAutor(autor)`** devuelve un array de libros escritos
          por `autor` <br />
          - **`filtrarPorGenero(genero)`** devuelve un array de libros con
          `genero` <br />
          - **`comprarLibros(idLibros)`** toma un array de ids de libros, si
          tienen stock, reduce el stock de dichos libros en 1 y suma a ganancias
          el precio de cada libro comprado <br />
          - **`obtenerGanancias`** devuelve `ganancias` <br />
        </p>
      </header>

      <main>
        <button type="button" class="btn-refresh" onclick="location.reload()">
          <span class="icon">‚Üª</span> Actualizar P√°gina
        </button>
      </main>
    </div>
    <script src="./js/script.js"></script>
    <script>
      class Autor {
        #nombre;
        #nacionalidad;

        constructor(nombre, nacionalidad) {
          this.#nombre = nombre;
          this.#nacionalidad = nacionalidad;
        }

        get nombre() {
          return this.#nombre;
        }
        get nacionalidad() {
          return this.#nacionalidad;
        }

        // M√©todo para obtener copia de los datos
        toObject() {
          return { nombre: this.#nombre, nacionalidad: this.#nacionalidad };
        }
      }

      class Libro {
        #id;
        #titulo;
        #autor;
        #precio;
        #genero;
        #stock;

        constructor(titulo, autor, precio, genero, stock) {
          this.#id = crypto.randomUUID().slice(0, 6);
          this.#titulo = titulo;
          this.#autor = autor; // Instancia de Autor
          this.#precio = Math.max(0, precio);
          this.#genero = genero;
          this.#stock = Math.max(0, stock);
        }

        // Getters
        get id() {
          return this.#id;
        }
        get titulo() {
          return this.#titulo;
        }
        get autor() {
          return this.#autor;
        }
        get precio() {
          return this.#precio;
        }
        get genero() {
          return this.#genero;
        }

        // Setters
        set precio(nuevoPrecio) {
          this.#precio = Math.max(0, nuevoPrecio);
        }
        set stock(nuevoStock) {
          this.#stock = Math.max(0, nuevoStock);
        }

        tieneStock() {
          return this.#stock > 0;
        }

        // M√©todo para devolver una copia segura del libro
        toObject() {
          return {
            id: this.#id,
            titulo: this.#titulo,
            autor: this.#autor.toObject(),
            precio: this.#precio,
            genero: this.#genero,
            stock: this.#stock, // Se incluye para informaci√≥n, pero protegida en la copia
          };
        }
      }

      class Libreria {
        #libros = [];
        #ganancias = 0;

        agregar(libro) {
          if (!(libro instanceof Libro))
            throw new Error("Debe ser una instancia de Libro");
          this.#libros.push(libro);
        }

        eliminar(id) {
          const indice = this.#libros.findIndex((l) => l.id === id);
          if (indice === -1) throw new Error("Libro no encontrado");
          this.#libros.splice(indice, 1);
        }

        buscarPorId(id) {
          const libro = this.#libros.find((l) => l.id === id);
          return libro ? libro.toObject() : undefined;
        }

        buscarPorTitulo(titulo) {
          const libro = this.#libros.find(
            (l) => l.titulo.toLowerCase() === titulo.toLowerCase()
          );
          return libro ? libro.toObject() : undefined;
        }

        filtrarPorAutor(nombreAutor) {
          return this.#libros
            .filter(
              (l) => l.autor.nombre.toLowerCase() === nombreAutor.toLowerCase()
            )
            .map((l) => l.toObject());
        }

        filtrarPorGenero(genero) {
          return this.#libros
            .filter((l) => l.genero.toLowerCase() === genero.toLowerCase())
            .map((l) => l.toObject());
        }

        comprarLibros(idLibros) {
          let totalCompra = 0;
          idLibros.forEach((id) => {
            const libro = this.#libros.find((l) => l.id === id);
            if (libro && libro.tieneStock()) {
              libro.stock -= 1; // Usamos el setter
              totalCompra += libro.precio;
            }
          });
          this.#ganancias += totalCompra;
          return totalCompra;
        }

        obtenerGanancias() {
          return this.#ganancias;
        }

        listarCatalogo() {
          return this.#libros
            .map(
              (l) =>
                `ID: ${l.id} | ${l.titulo} - ${l.autor.nombre} ($${
                  l.precio
                }) [Stock: ${l.tieneStock() ? "Disponible" : "Agotado"}]`
            )
            .join("\n");
        }
      }

      // --- Interacci√≥n con el usuario ---

      const miLibreria = new Libreria();

      // Precarga de autores y libros
      const autor1 = new Autor("Gabriel Garc√≠a M√°rquez", "Colombiana");
      miLibreria.agregar(
        new Libro("Cien a√±os de soledad", autor1, 2500, "Novela", 5)
      );
      miLibreria.agregar(
        new Libro("Cr√≥nica de una muerte anunciada", autor1, 1200, "Novela", 2)
      );

      let ejecutando = true;
      while (ejecutando) {
        const menu =
          `üìö LIBRER√çA VIRTUAL\n` +
          `Ganancias: $${miLibreria.obtenerGanancias()}\n\n` +
          `${miLibreria.listarCatalogo() || "(Vac√≠o)"}\n\n` +
          `1. Buscar por T√≠tulo\n2. Comprar (por ID)\n3. Filtrar por Autor\n4. Salir`;

        const opcion = prompt(menu);

        try {
          switch (opcion) {
            case "1":
              const tBusq = prompt("Ingresa el t√≠tulo:");
              const encontrado = miLibreria.buscarPorTitulo(tBusq);
              alert(
                encontrado
                  ? `Libro: ${encontrado.titulo}\nAutor: ${encontrado.autor.nombre}\nPrecio: $${encontrado.precio}`
                  : "No encontrado"
              );
              break;
            case "2":
              const idCompra = prompt(
                "Introduce el ID del libro que quieres comprar:"
              );
              const gastado = miLibreria.comprarLibros([idCompra]);
              if (gastado > 0) alert(`¬°Compra exitosa! Pagaste $${gastado}`);
              else
                alert(
                  "No se pudo realizar la compra (ID inv√°lido o sin stock)"
                );
              break;
            case "3":
              const aBusq = prompt("Nombre del autor:");
              const librosAutor = miLibreria.filtrarPorAutor(aBusq);
              const lista = librosAutor.map((l) => l.titulo).join("\n");
              alert(lista || "No hay libros de ese autor.");
              break;
            case "4":
            case null:
              ejecutando = false;
              break;
          }
        } catch (e) {
          alert("‚ö†Ô∏è " + e.message);
        }
      }
    </script>
  </body>
</html>
