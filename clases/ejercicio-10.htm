<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ejercicios con Clases en Javascript Ejercicio 10</title>
    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <a href="../clases.html" class="btn-volver">‚Üê Volver al √≠ndice</a>

        <h1>Ejercicio 10 Chat con Usuarios y Mensajes</h1>
        <p>
          Crear las siguientes clases con sus respectivos m√©todos y propiedades.
          Usar propiedades privadas. Cuando se devuelvan valores, si son objetos
          y arrays de las propiedades, devolver copias de los mismo, para evitar
          que puedan ser modificados.
        </p>
        <p style="color: var(--secondary-color); margin-top: 0.5rem">
          ### Usuario <br />
          - **Propiedades** <br />
          - id (string) <br />
          - nombre (string) <br />
          - **Constructor** <br />
          - genera un `id` autom√°tico y lo asigna a su propiedad <br />
          - el resto de propiedades las pide como argumentos y las asigna seg√∫n
          corresponda <br />
          - **M√©todos** <br />
          - getters para obtener los valores de todas las propiedades <br />
          <br />
          ### Mensaje <br />
          - **Propiedades** <br />
          - remitente (Usuario) <br />
          - destinatario (Usuario) <br />
          - texto (string) <br />
          - fecha (Date), inicializa con la fecha actual (`new Date()`) <br />
          - **Constructor** <br />
          - pide las propiedades no inicializadas como argumentos y las asigna
          seg√∫n corresponda <br />
          - **M√©todos** <br />
          - getters para obtener los valores de todas las propiedades <br />
          <br />
          ### Chat <br />
          - **Propiedades** <br />
          - usuario (`Usuario`) <br />
          - contactos (array de `Usuario`), inicializa vac√≠o <br />
          - mensajes (array de `Mensaje`), inicializa vac√≠o <br />
          - **Constructor** <br />
          - pide `usuario` como argumento y lo agrega a su respectiva propiedad
          <br />
          - **M√©todos** <br />
          - **`agregarContacto(usuario)`** agregar `usuario` a `contactos`
          <br />
          - **`obtenerContactos()`** devuelve un array con la lista de
          `contactos` <br />
          - **`obtenerMensaje()`** devuelve un array con la lista de `mensajes`
          <br />
          - **`filtrarPorContacto(id)`** devuelve un array con la lista de
          `mensajes` que tienen como `destinatario` un usuario <br />
          con `id` <br />
          - **`filtrarPorFecha(fecha)`** devuelve un array con la lista de
          `mensajes` que tienen `fecha` (mismo d√≠a, mes y a√±o) <br />
          - **`mandarMensaje(mensaje)`** agrega `mensaje` a `mensajes`, si
          `destinatario` es un usuario de la lista de contactos con y si
          `mensaje` no se encuentra ya en el array de `mensajes` <br />
          - **Observaciones** <br />
          - solo se pueden mandar mensajes a usuarios de la lista de
          `contactos`. En caso contrario, arrojar un error. <br />
        </p>
      </header>

      <main>
        <button type="button" class="btn-refresh" onclick="location.reload()">
          <span class="icon">‚Üª</span> Actualizar P√°gina
        </button>
      </main>
    </div>
    <script src="./js/script.js"></script>
    <script>
      class Usuario {
        #id;
        #nombre;

        constructor(nombre) {
          this.#id = crypto.randomUUID().slice(0, 8);
          this.#nombre = nombre;
        }

        get id() {
          return this.#id;
        }
        get nombre() {
          return this.#nombre;
        }

        toObject() {
          return { id: this.#id, nombre: this.#nombre };
        }
      }

      class Mensaje {
        #remitente;
        #destinatario;
        #texto;
        #fecha;

        constructor(remitente, destinatario, texto) {
          this.#remitente = remitente;
          this.#destinatario = destinatario;
          this.#texto = texto;
          this.#fecha = new Date();
        }

        get remitente() {
          return this.#remitente;
        }
        get destinatario() {
          return this.#destinatario;
        }
        get texto() {
          return this.#texto;
        }
        get fecha() {
          return this.#fecha;
        }

        toObject() {
          return {
            remitente: this.#remitente.toObject(),
            destinatario: this.#destinatario.toObject(),
            texto: this.#texto,
            fecha: new Date(this.#fecha),
          };
        }
      }

      class Chat {
        #usuario;
        #contactos = [];
        #mensajes = [];

        constructor(usuario) {
          this.#usuario = usuario;
        }

        agregarContacto(usuario) {
          if (!(usuario instanceof Usuario))
            throw new Error("Debe ser una instancia de Usuario");
          this.#contactos.push(usuario);
        }

        // Para el men√∫: devuelve copias seguras
        obtenerContactos() {
          return this.#contactos.map((c) => c.toObject());
        }

        // Para la l√≥gica interna: permite acceder a las instancias reales para crear Mensajes
        obtenerContactosOriginales() {
          return this.#contactos;
        }

        obtenerMensajes() {
          return this.#mensajes.map((m) => m.toObject());
        }

        mandarMensaje(mensaje) {
          if (!(mensaje instanceof Mensaje))
            throw new Error("El mensaje no es v√°lido.");

          const esContacto = this.#contactos.some(
            (c) => c.id === mensaje.destinatario.id
          );
          if (!esContacto) {
            throw new Error(
              "No puedes enviar mensajes a alguien que no est√° en tus contactos."
            );
          }

          if (!this.#mensajes.includes(mensaje)) {
            this.#mensajes.push(mensaje);
          }
        }

        filtrarPorContacto(id) {
          return this.#mensajes
            .filter((m) => m.destinatario.id === id)
            .map((m) => m.toObject());
        }

        filtrarPorFecha(fecha) {
          const f = new Date(fecha);
          return this.#mensajes
            .filter(
              (m) =>
                m.fecha.getDate() === f.getDate() &&
                m.fecha.getMonth() === f.getMonth() &&
                m.fecha.getFullYear() === f.getFullYear()
            )
            .map((m) => m.toObject());
        }
      }

      // --- L√ìGICA DE INTERACCI√ìN ---

      const miNombre = prompt("üì± Bienvenido al Chat. Introduce tu nombre:");
      const yo = new Usuario(miNombre || "Usuario");
      const miChat = new Chat(yo);

      let ejecutando = true;

      while (ejecutando) {
        const menu =
          `üí¨ CHAT DE: ${yo.nombre}\n\n` +
          `1. Agregar Contacto\n` +
          `2. Ver Contactos\n` +
          `3. Enviar Mensaje\n` +
          `4. Ver Mensajes Recibidos/Enviados\n` +
          `5. Salir`;

        const opcion = prompt(menu);

        try {
          switch (opcion) {
            case "1":
              const nombreC = prompt("Nombre del nuevo contacto:");
              if (nombreC) {
                miChat.agregarContacto(new Usuario(nombreC));
                alert("üë§ Contacto agregado.");
              }
              break;

            case "2":
              const contactos = miChat.obtenerContactos();
              const listaC = contactos
                .map((c) => `- ${c.nombre} (ID: ${c.id})`)
                .join("\n");
              alert(
                "üìñ TUS CONTACTOS:\n" + (listaC || "No tienes contactos a√∫n.")
              );
              break;

            case "3":
              const listaOriginal = miChat.obtenerContactosOriginales();
              if (listaOriginal.length === 0) {
                alert("‚ö†Ô∏è Primero debes agregar un contacto.");
              } else {
                const menuEleccion = listaOriginal
                  .map((c, i) => `${i}. ${c.nombre}`)
                  .join("\n");
                const indice = parseInt(
                  prompt("Elige el n√∫mero del destinatario:\n" + menuEleccion)
                );

                if (listaOriginal[indice]) {
                  const texto = prompt(
                    `Mensaje para ${listaOriginal[indice].nombre}:`
                  );
                  if (texto) {
                    const nuevoMsj = new Mensaje(
                      yo,
                      listaOriginal[indice],
                      texto
                    );
                    miChat.mandarMensaje(nuevoMsj);
                    alert("üì§ Mensaje enviado correctamente.");
                  }
                } else {
                  alert("√çndice no v√°lido.");
                }
              }
              break;

            case "4":
              const historial = miChat.obtenerMensajes();
              const textoHistorial = historial
                .map(
                  (m) =>
                    `[${m.fecha.toLocaleTimeString()}] ${
                      m.remitente.nombre
                    } ‚û°Ô∏è ${m.destinatario.nombre}: ${m.texto}`
                )
                .join("\n");
              alert(
                "üí¨ HISTORIAL DE MENSAJES:\n" +
                  (textoHistorial || "No hay mensajes en el chat.")
              );
              break;

            case "5":
            case null:
              ejecutando = false;
              alert("Saliendo del chat...");
              break;

            default:
              alert("Opci√≥n no reconocida.");
          }
        } catch (error) {
          alert("‚ö†Ô∏è Error: " + error.message);
        }
      }
    </script>
  </body>
</html>
